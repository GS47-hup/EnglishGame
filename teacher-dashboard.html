<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - Exam Results</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f9ff;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }
        
        @media (max-width: 640px) {
            body {
                font-size: 16px;
            }
        }
        .dashboard-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 640px) {
            .dashboard-card {
                padding: 20px;
                margin-bottom: 20px;
            }
        }
        .student-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .student-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .answer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        @media (min-width: 640px) {
            .answer-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
            }
        }
        .answer-item {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            font-size: 0.9rem;
        }
        .answer-correct {
            background: #ecfdf5;
            border-color: #10b981;
            color: #047857;
        }
        .answer-incorrect {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }
        .answer-missing {
            background: #fefce8;
            border-color: #f59e0b;
            color: #d97706;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .export-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        .export-btn:hover {
            background: #059669;
        }
        .clear-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .clear-btn:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <!-- Teacher Login Screen -->
    <div id="teacherLoginScreen" class="min-h-screen flex items-center justify-center bg-gray-50">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-user-shield text-4xl text-blue-500 mb-4"></i>
                <h1 class="text-2xl font-bold text-gray-800">Teacher Dashboard</h1>
                <p class="text-gray-600 mt-2">Enter password to access exam results</p>
            </div>
            
            <form id="teacherLoginForm">
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Teacher Password:</label>
                    <input type="password" id="teacherPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="Enter teacher password" required>
                </div>
                
                <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors">
                    <i class="fas fa-sign-in-alt mr-2"></i>Access Dashboard
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <a href="listening-exam.html" class="text-blue-500 hover:underline text-sm">
                    <i class="fas fa-arrow-left mr-1"></i>Back to Student Exam
                </a>
                <br><br>
                <div class="text-xs text-gray-500 bg-green-50 p-3 rounded">
                    <strong>üíæ Database Status:</strong> Connected to Neon PostgreSQL database. 
                    All exam data is stored permanently and accessible across devices.
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" class="container mx-auto px-4 py-8 max-w-6xl" style="display: none;">
        <!-- Header -->
        <div class="dashboard-card">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        <i class="fas fa-chalkboard-teacher mr-3 text-blue-500"></i>
                        Teacher Dashboard
                    </h1>
                    <p class="text-gray-600 mt-2">Digital Listening Exam & Placement Test Results</p>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-3 space-y-2 sm:space-y-0">
                    <button onclick="exportResults()" class="export-btn w-full sm:w-auto">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <button onclick="clearResults()" class="clear-btn w-full sm:w-auto">
                        <i class="fas fa-trash mr-2"></i>Clear All
                    </button>
                    <a href="listening-exam.html" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-center w-full sm:w-auto">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Exam
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid" id="statsContainer">
            <!-- Stats will be generated here -->
        </div>

        <!-- Listening Exam Results -->
        <div class="dashboard-card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-headphones mr-2"></i>Listening Exam Results (10 Questions)
            </h2>

            <div id="noResults" class="text-center py-12 text-gray-500" style="display: none;">
                <i class="fas fa-inbox text-6xl mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">No Listening Exam Submissions Yet</h3>
                <p>Students' listening exam results will appear here once they complete the exam.</p>
            </div>

            <div id="resultsContainer">
                <!-- Student results will be generated here -->
            </div>
        </div>

        <!-- Placement Test Results -->
        <div class="dashboard-card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-graduation-cap mr-2"></i>Placement Test Results (49 Questions + Writing)
            </h2>

            <div id="noPlacementResults" class="text-center py-12 text-gray-500" style="display: none;">
                <i class="fas fa-clipboard-list text-6xl mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">No Placement Test Submissions Yet</h3>
                <p>Students' placement test results will appear here once they complete the assessment.</p>
            </div>

            <div id="placementResultsContainer">
                <!-- Placement test results will be generated here -->
            </div>
        </div>
    </div>

    <script>
        // Correct answers for scoring
        const correctAnswers = {
            1: "üçé", 2: "üê±", 3: "üìö", 4: "üöó", 5: "üå∏",
            6: "‚öΩ", 7: "üå≥", 8: "üè†", 9: "üê¶", 10: "üêü"
        };

        let submissions = [];
        let placementSubmissions = [];
        const TEACHER_PASSWORD = 'teacher123'; // Change this password as needed

        // Teacher login functionality
        document.getElementById('teacherLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('teacherPassword').value;
            
            if (password === TEACHER_PASSWORD) {
                document.getElementById('teacherLoginScreen').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                loadSubmissions();
            } else {
                alert('Incorrect password. Please try again.');
                document.getElementById('teacherPassword').value = '';
            }
        });

        function loadSubmissions() {
            // Show loading indicators
            const resultsContainer = document.getElementById('resultsContainer');
            const placementResultsContainer = document.getElementById('placementResultsContainer');

            resultsContainer.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i><p class="mt-2 text-gray-600">Loading listening exam submissions...</p></div>';
            placementResultsContainer.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i><p class="mt-2 text-gray-600">Loading placement test submissions...</p></div>';

            // Load both listening exam and placement test results
            Promise.all([
                fetch('/.netlify/functions/get-submissions').then(response => response.json()),
                fetch('/.netlify/functions/get-placement-submissions').then(response => response.json())
            ])
            .then(([listeningData, placementData]) => {
                // Handle listening exam results
                if (listeningData.success) {
                    submissions = listeningData.submissions;
                    console.log(`Loaded ${listeningData.count} listening exam submissions from database`);
                } else {
                    console.error('Error loading listening submissions:', listeningData.error);
                    submissions = [];
                }

                // Handle placement test results
                if (placementData.success) {
                    placementSubmissions = placementData.submissions;
                    console.log(`Loaded ${placementData.count} placement test submissions from database`);
                } else {
                    console.error('Error loading placement submissions:', placementData.error);
                    placementSubmissions = [];
                }

                displayStatistics();
                displayResults();
                displayPlacementResults();
            })
            .catch(error => {
                console.error('Error fetching submissions:', error);
                submissions = [];
                placementSubmissions = [];
                displayStatistics();
                displayResults();
                displayPlacementResults();

                // Show error messages
                const resultsContainer = document.getElementById('resultsContainer');
                const placementResultsContainer = document.getElementById('placementResultsContainer');

                const errorMessage = `
                    <div class="text-center py-8 text-red-600">
                        <i class="fas fa-exclamation-triangle text-3xl mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">Connection Error</h3>
                        <p>Unable to connect to database. Please check your internet connection.</p>
                        <button onclick="loadSubmissions()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            <i class="fas fa-refresh mr-2"></i>Retry
                        </button>
                    </div>
                `;

                resultsContainer.innerHTML = errorMessage;
                placementResultsContainer.innerHTML = errorMessage;
            });
        }

        function displayStatistics() {
            const statsContainer = document.getElementById('statsContainer');

            // Calculate listening exam statistics
            const listeningStudents = submissions.length;
            const listeningQuestions = 10;
            let listeningCorrect = 0;
            let listeningCompleted = 0;

            submissions.forEach(submission => {
                if (submission.completed) listeningCompleted++;

                submission.answers.forEach(answer => {
                    if (correctAnswers[answer.number] === answer.image) {
                        listeningCorrect++;
                    }
                });
            });

            const listeningAverage = listeningStudents > 0 ? ((listeningCorrect / (listeningStudents * listeningQuestions)) * 100).toFixed(1) : 0;

            // Calculate placement test statistics
            const placementStudents = placementSubmissions.length;
            let placementTotalScore = 0;
            let placementLevel4Ready = 0;

            placementSubmissions.forEach(submission => {
                placementTotalScore += submission.totalScore;
                if (submission.placementLevel === 'Level 4' || submission.placementLevel === 'Level 4+') {
                    placementLevel4Ready++;
                }
            });

            const placementAverage = placementStudents > 0 ? ((placementTotalScore / (placementStudents * 49)) * 100).toFixed(1) : 0;
            const level4ReadyPercent = placementStudents > 0 ? ((placementLevel4Ready / placementStudents) * 100).toFixed(1) : 0;

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${listeningStudents}</div>
                    <div>Listening Exam Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${placementStudents}</div>
                    <div>Placement Test Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${listeningAverage}%</div>
                    <div>Listening Avg Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${placementAverage}%</div>
                    <div>Placement Avg Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${level4ReadyPercent}%</div>
                    <div>Level 4 Ready</div>
                </div>
            `;
        }

        function displayResults() {
            const resultsContainer = document.getElementById('resultsContainer');
            const noResults = document.getElementById('noResults');

            if (submissions.length === 0) {
                noResults.style.display = 'block';
                resultsContainer.innerHTML = '';
                return;
            }

            noResults.style.display = 'none';
            
            resultsContainer.innerHTML = submissions.map(submission => {
                const score = calculateScore(submission);
                const percentage = ((score / 10) * 100).toFixed(1);
                const timestamp = new Date(submission.timestamp).toLocaleString();
                
                return `
                    <div class="student-card">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">
                                    <i class="fas fa-user-graduate mr-2 text-blue-500"></i>
                                    ${submission.studentName}
                                </h3>
                                <p class="text-sm text-gray-600">Submitted: ${timestamp}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold ${percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${score}/10
                                </div>
                                <div class="text-sm text-gray-600">${percentage}%</div>
                            </div>
                        </div>
                        
                        <div class="answer-grid">
                            ${generateAnswerGrid(submission)}
                        </div>
                        
                        <div class="mt-3 flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                <span class="text-green-600">‚úì ${score} Correct</span> ‚Ä¢ 
                                <span class="text-red-600">‚úó ${10 - score} Incorrect</span>
                            </div>
                            <button onclick="viewDetails('${submission.studentName}')" class="text-blue-500 hover:underline text-sm">
                                <i class="fas fa-eye mr-1"></i>View Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculateScore(submission) {
            let score = 0;
            submission.answers.forEach(answer => {
                if (correctAnswers[answer.number] === answer.image) {
                    score++;
                }
            });
            return score;
        }

        function generateAnswerGrid(submission) {
            let grid = '';
            for (let i = 1; i <= 10; i++) {
                const studentAnswer = submission.answers.find(answer => answer.number === i);
                const correctAnswer = correctAnswers[i];
                
                if (!studentAnswer) {
                    grid += `<div class="answer-item answer-missing">
                        ${i}. No Answer
                    </div>`;
                } else if (studentAnswer.image === correctAnswer) {
                    grid += `<div class="answer-item answer-correct">
                        ${i}. ${studentAnswer.image} ‚úì
                    </div>`;
                } else {
                    grid += `<div class="answer-item answer-incorrect">
                        ${i}. ${studentAnswer.image} ‚úó
                    </div>`;
                }
            }
            return grid;
        }

        function viewDetails(studentName) {
            const submission = submissions.find(s => s.studentName === studentName);
            if (!submission) return;

            let details = `Student: ${studentName}\n\n`;
            details += `Submitted: ${new Date(submission.timestamp).toLocaleString()}\n\n`;
            details += `Detailed Answers:\n`;
            
            for (let i = 1; i <= 10; i++) {
                const studentAnswer = submission.answers.find(answer => answer.number === i);
                const correctAnswer = correctAnswers[i];
                
                if (!studentAnswer) {
                    details += `${i}. No answer (Correct: ${correctAnswer})\n`;
                } else if (studentAnswer.image === correctAnswer) {
                    details += `${i}. ${studentAnswer.image} ‚úì (Correct)\n`;
                } else {
                    details += `${i}. ${studentAnswer.image} ‚úó (Correct: ${correctAnswer})\n`;
                }
            }

            alert(details);
        }

        function displayPlacementResults() {
            const placementResultsContainer = document.getElementById('placementResultsContainer');
            const noPlacementResults = document.getElementById('noPlacementResults');

            if (placementSubmissions.length === 0) {
                noPlacementResults.style.display = 'block';
                placementResultsContainer.innerHTML = '';
                return;
            }

            noPlacementResults.style.display = 'none';

            const resultsHTML = placementSubmissions.map(submission => {
                const timestamp = new Date(submission.timestamp).toLocaleString();
                const completionTime = submission.completionTime || 'N/A';

                return `
                    <div class="student-card">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-4">
                            <div class="mb-2 sm:mb-0">
                                <h3 class="text-lg font-bold text-gray-800">${submission.studentName}</h3>
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-clock mr-1"></i>Submitted: ${timestamp}
                                </p>
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-stopwatch mr-1"></i>Completion Time: ${completionTime}
                                </p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-blue-600">${submission.totalScore}/49</div>
                                <div class="text-sm text-gray-600">${((submission.totalScore / 49) * 100).toFixed(1)}%</div>
                                <div class="text-sm font-semibold text-green-600 mt-1">${submission.placementLevel}</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-50 p-3 rounded">
                                <h4 class="font-semibold text-blue-800">Level 3 Score</h4>
                                <div class="text-xl font-bold text-blue-600">${submission.level3Score}/24</div>
                                <div class="text-sm text-gray-600">${((submission.level3Score / 24) * 100).toFixed(1)}%</div>
                            </div>
                            <div class="bg-purple-50 p-3 rounded">
                                <h4 class="font-semibold text-purple-800">Level 4 Score</h4>
                                <div class="text-xl font-bold text-purple-600">${submission.level4Score}/25</div>
                                <div class="text-sm text-gray-600">${((submission.level4Score / 25) * 100).toFixed(1)}%</div>
                            </div>
                        </div>

                        <div class="bg-green-50 p-3 rounded mb-4">
                            <h4 class="font-semibold text-green-800 mb-1">Recommendation</h4>
                            <p class="text-sm text-green-700">${submission.recommendation}</p>
                        </div>

                        ${submission.writingContent ? `
                        <div class="bg-gray-50 p-3 rounded">
                            <h4 class="font-semibold text-gray-800 mb-1">Writing Task (${submission.writingTask})</h4>
                            <p class="text-sm text-gray-700 whitespace-pre-wrap">${submission.writingContent}</p>
                        </div>
                        ` : ''}

                        ${generatePlacementAnswerGrid(submission)}

                        <div class="mt-4 flex flex-wrap gap-2">
                            <button onclick="showPlacementDetails('${submission.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                <i class="fas fa-eye mr-1"></i>View Details
                            </button>
                            <span class="text-xs text-gray-500">Questions Answered: ${submission.questionsAnswered}/49</span>
                        </div>
                    </div>
                `;
            }).join('');

            placementResultsContainer.innerHTML = resultsHTML;
        }

        function generatePlacementAnswerGrid(submission) {
            // Correct answers for placement test
            const correctAnswers = {
                // Level 3 Assessment (Questions 1-24)
                'question_1': 'a', 'question_2': 'b', 'question_3': 'a', 'question_4': 'b', 'question_5': 'a',
                // question_6 is text input - handled separately
                'question_7': 'c', 'question_8': 'b', 'question_9': 'a', 'question_10': 'c', 'question_11': 'a',
                'question_12': 'c', 'question_13': 'b', 'question_14': 'a', 'question_15': 'b', 'question_16': 'b',
                'question_17': 'c', 'question_18': 'a', 'question_19': 'a', 'question_20': 'b', 'question_21': 'a',
                'question_22': 'b', 'question_23': 'b', 'question_24': 'a',

                // Level 4 Assessment (Questions 25-49)
                'question_25': 'b', 'question_26': 'a', 'question_27': 'c', 'question_28': 'b', 'question_29': 'a',
                'question_30': 'c', 'question_31': 'b', 'question_32': 'c', 'question_33': 'b', 'question_34': 'a',
                'question_35': 'a', 'question_36': 'b', 'question_37': 'c', 'question_38': 'b', 'question_39': 'b',
                'question_40': 'b', 'question_41': 'a', 'question_42': 'b', 'question_43': 'a', 'question_44': 'a',
                'question_45': 'b', 'question_46': 'b', 'question_47': 'c', 'question_48': 'a', 'question_49': 'a'
            };

            let gridHTML = `
                <div style="margin-top: 15px;">
                    <h4 style="font-weight: bold; margin-bottom: 10px; color: #374151;">Question Analysis (1-49):</h4>
                    <div class="answer-grid">
            `;

            for (let i = 1; i <= 49; i++) {
                let cellClass = 'answer-item';
                let cellContent = i;

                if (i === 6) {
                    // Special handling for Question 6 (text input)
                    const textAnswer = submission.answers.question_6_text;
                    if (!textAnswer) {
                        cellClass += ' answer-missing';
                        cellContent = `${i}<br><small>No Answer</small>`;
                    } else {
                        // Check if answer contains expected keywords
                        const q6Keywords = ['department store', 'post office', 'movie theater', 'supermarket'];
                        const lowerAnswer = textAnswer.toLowerCase();
                        const matchCount = q6Keywords.filter(keyword => lowerAnswer.includes(keyword.toLowerCase())).length;

                        if (matchCount >= 3) {
                            cellClass += ' answer-correct';
                            cellContent = `${i}<br><small>‚úì TEXT</small>`;
                        } else if (matchCount >= 1) {
                            cellClass += ' answer-incorrect';
                            cellContent = `${i}<br><small>~ TEXT</small>`;
                        } else {
                            cellClass += ' answer-incorrect';
                            cellContent = `${i}<br><small>‚úó TEXT</small>`;
                        }
                    }
                } else {
                    // Regular multiple choice questions
                    const studentAnswer = submission.answers[`question_${i}`];
                    const correctAnswer = correctAnswers[`question_${i}`];

                    if (!studentAnswer) {
                        cellClass += ' answer-missing';
                        cellContent = `${i}<br><small>No Answer</small>`;
                    } else if (studentAnswer === correctAnswer) {
                        cellClass += ' answer-correct';
                        cellContent = `${i}<br><small>‚úì ${studentAnswer.toUpperCase()}</small>`;
                    } else {
                        cellClass += ' answer-incorrect';
                        cellContent = `${i}<br><small>‚úó ${studentAnswer.toUpperCase()}</small>`;
                    }
                }

                gridHTML += `<div class="${cellClass}">${cellContent}</div>`;
            }

            gridHTML += `
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                        <span style="background: #ecfdf5; padding: 2px 6px; border-radius: 3px; margin-right: 8px;">‚úì Correct</span>
                        <span style="background: #fef2f2; padding: 2px 6px; border-radius: 3px; margin-right: 8px;">‚úó Incorrect</span>
                        <span style="background: #fefce8; padding: 2px 6px; border-radius: 3px;">‚ö™ No Answer</span>
                    </div>
                </div>
            `;

            return gridHTML;
        }

        function showPlacementDetails(submissionId) {
            const submission = placementSubmissions.find(sub => sub.id == submissionId);
            if (!submission) {
                alert('Submission not found');
                return;
            }

            // Correct answers for placement test
            const correctAnswers = {
                // Level 3 Assessment (Questions 1-24)
                'question_1': 'a', 'question_2': 'b', 'question_3': 'a', 'question_4': 'b', 'question_5': 'a',
                // question_6 is text input - handled separately
                'question_7': 'c', 'question_8': 'b', 'question_9': 'a', 'question_10': 'c', 'question_11': 'a',
                'question_12': 'c', 'question_13': 'b', 'question_14': 'a', 'question_15': 'b', 'question_16': 'b',
                'question_17': 'c', 'question_18': 'a', 'question_19': 'a', 'question_20': 'b', 'question_21': 'a',
                'question_22': 'b', 'question_23': 'b', 'question_24': 'a',

                // Level 4 Assessment (Questions 25-49)
                'question_25': 'b', 'question_26': 'a', 'question_27': 'c', 'question_28': 'b', 'question_29': 'a',
                'question_30': 'c', 'question_31': 'b', 'question_32': 'c', 'question_33': 'b', 'question_34': 'a',
                'question_35': 'a', 'question_36': 'b', 'question_37': 'c', 'question_38': 'b', 'question_39': 'b',
                'question_40': 'b', 'question_41': 'a', 'question_42': 'b', 'question_43': 'a', 'question_44': 'a',
                'question_45': 'b', 'question_46': 'b', 'question_47': 'c', 'question_48': 'a', 'question_49': 'a'
            };

            let details = `üìã PLACEMENT TEST ANALYSIS: ${submission.studentName}\n`;
            details += `================================================================\n`;
            details += `üìÖ Submission: ${new Date(submission.timestamp).toLocaleString()}\n`;
            details += `‚è±Ô∏è Time Taken: ${submission.completionTime}\n`;
            details += `üìä Overall Score: ${submission.totalScore}/49 (${((submission.totalScore / 49) * 100).toFixed(1)}%)\n`;
            details += `üìö Level 3 Score: ${submission.level3Score}/24 (${((submission.level3Score / 24) * 100).toFixed(1)}%)\n`;
            details += `üöÄ Level 4 Score: ${submission.level4Score}/25 (${((submission.level4Score / 25) * 100).toFixed(1)}%)\n`;
            details += `üéØ Placement: ${submission.placementLevel}\n`;
            details += `üí° Recommendation: ${submission.recommendation}\n\n`;

            if (submission.writingContent) {
                details += `‚úçÔ∏è WRITING TASK (${submission.writingTask}):\n`;
                details += `${'-'.repeat(40)}\n`;
                details += `${submission.writingContent}\n\n`;
            }

            details += `üìù DETAILED QUESTION ANALYSIS:\n`;
            details += `================================================================\n`;

            let correctCount = 0;
            let incorrectCount = 0;
            let unansweredCount = 0;

            // Level 3 Questions (1-24)
            details += `\nüìö LEVEL 3 QUESTIONS (1-24):\n`;
            details += `${'-'.repeat(40)}\n`;
            for (let i = 1; i <= 24; i++) {
                if (i === 6) {
                    // Special handling for Question 6 (text input)
                    const textAnswer = submission.answers.question_6_text;
                    if (!textAnswer) {
                        details += `Q06: ‚ùå NO ANSWER (Expected: department store, post office, movie theater, supermarket)\n`;
                        unansweredCount++;
                    } else {
                        const q6Keywords = ['department store', 'post office', 'movie theater', 'supermarket'];
                        const lowerAnswer = textAnswer.toLowerCase();
                        const matchCount = q6Keywords.filter(keyword => lowerAnswer.includes(keyword.toLowerCase())).length;

                        if (matchCount >= 3) {
                            details += `Q06: ‚úÖ TEXT ANSWER (${matchCount}/4 keywords found)\n`;
                            details += `     "${textAnswer}"\n`;
                            correctCount++;
                        } else if (matchCount >= 1) {
                            details += `Q06: ‚ö†Ô∏è PARTIAL (${matchCount}/4 keywords found)\n`;
                            details += `     "${textAnswer}"\n`;
                            incorrectCount++;
                        } else {
                            details += `Q06: ‚ùå INCORRECT (0/4 keywords found)\n`;
                            details += `     "${textAnswer}"\n`;
                            incorrectCount++;
                        }
                    }
                } else {
                    // Regular multiple choice questions
                    const studentAnswer = submission.answers[`question_${i}`];
                    const correctAnswer = correctAnswers[`question_${i}`];

                    if (!studentAnswer) {
                        details += `Q${i.toString().padStart(2, '0')}: ‚ùå NO ANSWER (Correct: ${correctAnswer})\n`;
                        unansweredCount++;
                    } else if (studentAnswer === correctAnswer) {
                        details += `Q${i.toString().padStart(2, '0')}: ‚úÖ ${studentAnswer.toUpperCase()} (CORRECT)\n`;
                        correctCount++;
                    } else {
                        details += `Q${i.toString().padStart(2, '0')}: ‚ùå ${studentAnswer.toUpperCase()} (Correct: ${correctAnswer})\n`;
                        incorrectCount++;
                    }
                }
            }

            // Level 4 Questions (25-49)
            details += `\nüöÄ LEVEL 4 QUESTIONS (25-49):\n`;
            details += `${'-'.repeat(40)}\n`;
            for (let i = 25; i <= 49; i++) {
                const studentAnswer = submission.answers[`question_${i}`];
                const correctAnswer = correctAnswers[`question_${i}`];

                if (!studentAnswer) {
                    details += `Q${i.toString().padStart(2, '0')}: ‚ùå NO ANSWER (Correct: ${correctAnswer})\n`;
                    unansweredCount++;
                } else if (studentAnswer === correctAnswer) {
                    details += `Q${i.toString().padStart(2, '0')}: ‚úÖ ${studentAnswer.toUpperCase()} (CORRECT)\n`;
                    correctCount++;
                } else {
                    details += `Q${i.toString().padStart(2, '0')}: ‚ùå ${studentAnswer.toUpperCase()} (Correct: ${correctAnswer})\n`;
                    incorrectCount++;
                }
            }


            details += `\nüìä SUMMARY STATISTICS:\n`;
            details += `================================================================\n`;
            details += `‚úÖ Correct Answers: ${correctCount}/49 (${((correctCount / 49) * 100).toFixed(1)}%)\n`;
            details += `‚ùå Incorrect Answers: ${incorrectCount}/49 (${((incorrectCount / 49) * 100).toFixed(1)}%)\n`;
            details += `‚ö™ Unanswered: ${unansweredCount}/49 (${((unansweredCount / 49) * 100).toFixed(1)}%)\n`;

            alert(details);
        }

        function exportResults() {
            if (submissions.length === 0) {
                alert('No results to export!');
                return;
            }

            let csv = 'Student Name,Submission Time,Score,Percentage,Q1,Q2,Q3,Q4,Q5,Q6,Q7,Q8,Q9,Q10\n';
            
            submissions.forEach(submission => {
                const score = calculateScore(submission);
                const percentage = ((score / 10) * 100).toFixed(1);
                const timestamp = new Date(submission.timestamp).toLocaleString();
                
                let row = `"${submission.studentName}","${timestamp}",${score},${percentage}%`;
                
                for (let i = 1; i <= 10; i++) {
                    const studentAnswer = submission.answers.find(answer => answer.number === i);
                    const correctAnswer = correctAnswers[i];
                    
                    if (!studentAnswer) {
                        row += ',No Answer';
                    } else if (studentAnswer.image === correctAnswer) {
                        row += `,${studentAnswer.image} (Correct)`;
                    } else {
                        row += `,${studentAnswer.image} (Wrong: ${correctAnswer})`;
                    }
                }
                
                csv += row + '\n';
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `listening_exam_results_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function clearResults() {
            if (confirm('Are you sure you want to clear all exam results? This action cannot be undone.')) {
                // Show loading state
                const clearBtn = document.querySelector('.clear-btn');
                const originalText = clearBtn.innerHTML;
                clearBtn.disabled = true;
                clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Clearing...';
                
                fetch('/.netlify/functions/clear-submissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        submissions = [];
                        displayStatistics();
                        displayResults();
                        alert(`${data.message}`);
                    } else {
                        alert('Error clearing results: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error clearing results:', error);
                    alert('Error connecting to database.');
                })
                .finally(() => {
                    // Restore button state
                    clearBtn.disabled = false;
                    clearBtn.innerHTML = originalText;
                });
            }
        }

        // Auto-refresh every 30 seconds (only if dashboard is visible)
        setInterval(() => {
            if (document.getElementById('dashboardContent').style.display !== 'none') {
                loadSubmissions();
            }
        }, 30000);

        // Initial load happens after login
    </script>
</body>
</html>