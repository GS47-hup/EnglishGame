<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - Exam Results</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background-color: #f0f9ff;
        }
        .dashboard-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .student-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .student-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .answer-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .answer-item {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            font-size: 0.9rem;
        }
        .answer-correct {
            background: #ecfdf5;
            border-color: #10b981;
            color: #047857;
        }
        .answer-incorrect {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }
        .answer-missing {
            background: #fefce8;
            border-color: #f59e0b;
            color: #d97706;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .export-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        .export-btn:hover {
            background: #059669;
        }
        .clear-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .clear-btn:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <!-- Teacher Login Screen -->
    <div id="teacherLoginScreen" class="min-h-screen flex items-center justify-center bg-gray-50">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-user-shield text-4xl text-blue-500 mb-4"></i>
                <h1 class="text-2xl font-bold text-gray-800">Teacher Dashboard</h1>
                <p class="text-gray-600 mt-2">Enter password to access exam results</p>
            </div>
            
            <form id="teacherLoginForm">
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Teacher Password:</label>
                    <input type="password" id="teacherPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="Enter teacher password" required>
                </div>
                
                <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors">
                    <i class="fas fa-sign-in-alt mr-2"></i>Access Dashboard
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <a href="listening-exam.html" class="text-blue-500 hover:underline text-sm">
                    <i class="fas fa-arrow-left mr-1"></i>Back to Student Exam
                </a>
                <br><br>
                <div class="text-xs text-gray-500 bg-green-50 p-3 rounded">
                    <strong>üíæ Database Status:</strong> Connected to Neon PostgreSQL database. 
                    All exam data is stored permanently and accessible across devices.
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" class="container mx-auto px-4 py-8 max-w-6xl" style="display: none;">
        <!-- Header -->
        <div class="dashboard-card">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        <i class="fas fa-chalkboard-teacher mr-3 text-blue-500"></i>
                        Teacher Dashboard
                    </h1>
                    <p class="text-gray-600 mt-2">Digital Listening Exam Results</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="exportResults()" class="export-btn">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <button onclick="clearResults()" class="clear-btn">
                        <i class="fas fa-trash mr-2"></i>Clear All
                    </button>
                    <a href="listening-exam.html" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Exam
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid" id="statsContainer">
            <!-- Stats will be generated here -->
        </div>

        <!-- Student Results -->
        <div class="dashboard-card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-users mr-2"></i>Student Results
            </h2>
            
            <div id="noResults" class="text-center py-12 text-gray-500" style="display: none;">
                <i class="fas fa-inbox text-6xl mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">No Exam Submissions Yet</h3>
                <p>Students' exam results will appear here once they complete the exam.</p>
            </div>

            <div id="resultsContainer">
                <!-- Student results will be generated here -->
            </div>
        </div>
    </div>

    <script>
        // Correct answers for scoring
        const correctAnswers = {
            1: "üçé", 2: "üê±", 3: "üìö", 4: "üöó", 5: "üå∏",
            6: "‚öΩ", 7: "üå≥", 8: "üè†", 9: "üê¶", 10: "üêü"
        };

        let submissions = [];
        const TEACHER_PASSWORD = 'teacher123'; // Change this password as needed

        // Teacher login functionality
        document.getElementById('teacherLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('teacherPassword').value;
            
            if (password === TEACHER_PASSWORD) {
                document.getElementById('teacherLoginScreen').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                loadSubmissions();
            } else {
                alert('Incorrect password. Please try again.');
                document.getElementById('teacherPassword').value = '';
            }
        });

        function loadSubmissions() {
            // Show loading indicator
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i><p class="mt-2 text-gray-600">Loading submissions from database...</p></div>';
            
            // Fetch from Neon database via Netlify Function
            fetch('/.netlify/functions/get-submissions')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        submissions = data.submissions;
                        console.log(`Loaded ${data.count} submissions from database`);
                    } else {
                        console.error('Error loading submissions:', data.error);
                        submissions = [];
                    }
                    displayStatistics();
                    displayResults();
                })
                .catch(error => {
                    console.error('Error fetching submissions:', error);
                    submissions = [];
                    displayStatistics();
                    displayResults();
                    
                    // Show error message
                    const resultsContainer = document.getElementById('resultsContainer');
                    resultsContainer.innerHTML = `
                        <div class="text-center py-8 text-red-600">
                            <i class="fas fa-exclamation-triangle text-3xl mb-4"></i>
                            <h3 class="text-xl font-semibold mb-2">Connection Error</h3>
                            <p>Unable to connect to database. Please check your internet connection.</p>
                            <button onclick="loadSubmissions()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                <i class="fas fa-refresh mr-2"></i>Retry
                            </button>
                        </div>
                    `;
                });
        }

        function displayStatistics() {
            const statsContainer = document.getElementById('statsContainer');
            
            if (submissions.length === 0) {
                statsContainer.innerHTML = '';
                return;
            }

            const totalStudents = submissions.length;
            const totalQuestions = 10;
            let totalCorrect = 0;
            let completedExams = 0;

            submissions.forEach(submission => {
                if (submission.completed) completedExams++;
                
                submission.answers.forEach(answer => {
                    if (correctAnswers[answer.number] === answer.image) {
                        totalCorrect++;
                    }
                });
            });

            const averageScore = totalStudents > 0 ? ((totalCorrect / (totalStudents * totalQuestions)) * 100).toFixed(1) : 0;
            const completionRate = totalStudents > 0 ? ((completedExams / totalStudents) * 100).toFixed(1) : 0;

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalStudents}</div>
                    <div>Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${completedExams}</div>
                    <div>Completed Exams</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${averageScore}%</div>
                    <div>Average Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${completionRate}%</div>
                    <div>Completion Rate</div>
                </div>
            `;
        }

        function displayResults() {
            const resultsContainer = document.getElementById('resultsContainer');
            const noResults = document.getElementById('noResults');

            if (submissions.length === 0) {
                noResults.style.display = 'block';
                resultsContainer.innerHTML = '';
                return;
            }

            noResults.style.display = 'none';
            
            resultsContainer.innerHTML = submissions.map(submission => {
                const score = calculateScore(submission);
                const percentage = ((score / 10) * 100).toFixed(1);
                const timestamp = new Date(submission.timestamp).toLocaleString();
                
                return `
                    <div class="student-card">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">
                                    <i class="fas fa-user-graduate mr-2 text-blue-500"></i>
                                    ${submission.studentName}
                                </h3>
                                <p class="text-sm text-gray-600">Submitted: ${timestamp}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold ${percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${score}/10
                                </div>
                                <div class="text-sm text-gray-600">${percentage}%</div>
                            </div>
                        </div>
                        
                        <div class="answer-grid">
                            ${generateAnswerGrid(submission)}
                        </div>
                        
                        <div class="mt-3 flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                <span class="text-green-600">‚úì ${score} Correct</span> ‚Ä¢ 
                                <span class="text-red-600">‚úó ${10 - score} Incorrect</span>
                            </div>
                            <button onclick="viewDetails('${submission.studentName}')" class="text-blue-500 hover:underline text-sm">
                                <i class="fas fa-eye mr-1"></i>View Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculateScore(submission) {
            let score = 0;
            submission.answers.forEach(answer => {
                if (correctAnswers[answer.number] === answer.image) {
                    score++;
                }
            });
            return score;
        }

        function generateAnswerGrid(submission) {
            let grid = '';
            for (let i = 1; i <= 10; i++) {
                const studentAnswer = submission.answers.find(answer => answer.number === i);
                const correctAnswer = correctAnswers[i];
                
                if (!studentAnswer) {
                    grid += `<div class="answer-item answer-missing">
                        ${i}. No Answer
                    </div>`;
                } else if (studentAnswer.image === correctAnswer) {
                    grid += `<div class="answer-item answer-correct">
                        ${i}. ${studentAnswer.image} ‚úì
                    </div>`;
                } else {
                    grid += `<div class="answer-item answer-incorrect">
                        ${i}. ${studentAnswer.image} ‚úó
                    </div>`;
                }
            }
            return grid;
        }

        function viewDetails(studentName) {
            const submission = submissions.find(s => s.studentName === studentName);
            if (!submission) return;

            let details = `Student: ${studentName}\n\n`;
            details += `Submitted: ${new Date(submission.timestamp).toLocaleString()}\n\n`;
            details += `Detailed Answers:\n`;
            
            for (let i = 1; i <= 10; i++) {
                const studentAnswer = submission.answers.find(answer => answer.number === i);
                const correctAnswer = correctAnswers[i];
                
                if (!studentAnswer) {
                    details += `${i}. No answer (Correct: ${correctAnswer})\n`;
                } else if (studentAnswer.image === correctAnswer) {
                    details += `${i}. ${studentAnswer.image} ‚úì (Correct)\n`;
                } else {
                    details += `${i}. ${studentAnswer.image} ‚úó (Correct: ${correctAnswer})\n`;
                }
            }

            alert(details);
        }

        function exportResults() {
            if (submissions.length === 0) {
                alert('No results to export!');
                return;
            }

            let csv = 'Student Name,Submission Time,Score,Percentage,Q1,Q2,Q3,Q4,Q5,Q6,Q7,Q8,Q9,Q10\n';
            
            submissions.forEach(submission => {
                const score = calculateScore(submission);
                const percentage = ((score / 10) * 100).toFixed(1);
                const timestamp = new Date(submission.timestamp).toLocaleString();
                
                let row = `"${submission.studentName}","${timestamp}",${score},${percentage}%`;
                
                for (let i = 1; i <= 10; i++) {
                    const studentAnswer = submission.answers.find(answer => answer.number === i);
                    const correctAnswer = correctAnswers[i];
                    
                    if (!studentAnswer) {
                        row += ',No Answer';
                    } else if (studentAnswer.image === correctAnswer) {
                        row += `,${studentAnswer.image} (Correct)`;
                    } else {
                        row += `,${studentAnswer.image} (Wrong: ${correctAnswer})`;
                    }
                }
                
                csv += row + '\n';
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `listening_exam_results_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function clearResults() {
            if (confirm('Are you sure you want to clear all exam results? This action cannot be undone.')) {
                // Show loading state
                const clearBtn = document.querySelector('.clear-btn');
                const originalText = clearBtn.innerHTML;
                clearBtn.disabled = true;
                clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Clearing...';
                
                fetch('/.netlify/functions/clear-submissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        submissions = [];
                        displayStatistics();
                        displayResults();
                        alert(`${data.message}`);
                    } else {
                        alert('Error clearing results: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error clearing results:', error);
                    alert('Error connecting to database.');
                })
                .finally(() => {
                    // Restore button state
                    clearBtn.disabled = false;
                    clearBtn.innerHTML = originalText;
                });
            }
        }

        // Auto-refresh every 30 seconds (only if dashboard is visible)
        setInterval(() => {
            if (document.getElementById('dashboardContent').style.display !== 'none') {
                loadSubmissions();
            }
        }, 30000);

        // Initial load happens after login
    </script>
</body>
</html>